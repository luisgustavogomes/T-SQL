USE	Treinamento	
GO 

IF OBJECT_ID('tempdb..##CONTAS') IS NOT NULL
    DROP TABLE ##CONTAS

CREATE TABLE ##CONTAS  (
  ANO SMALLINT,
  BANCO VARCHAR(100),
  TIPO VARCHAR(100),
  VALOR MONEY
)
 
INSERT INTO ##CONTAS VALUES
(2009,'BANCO ALVORADA S/A','INVESTIMENTOS',6175979775.42),
(2010,'BANCO ALVORADA S/A','INVESTIMENTOS',6486892688.53),
(2011,'BANCO ALVORADA S/A','INVESTIMENTOS',7905663406.86),
(2012,'BANCO ALVORADA S/A','INVESTIMENTOS',9613906084.01),
(2009,'BANCO ARBI S/A','INVESTIMENTOS',8102644.84),
(2009,'BANCO ARBI S/A','OUTROS',174343.35),
(2010,'BANCO ARBI S/A','INVESTIMENTOS',7935411.15),
(2010,'BANCO ARBI S/A','OUTROS',119885.82),
(2011,'BANCO ARBI S/A','INVESTIMENTOS',8202652.29),
(2011,'BANCO ARBI S/A','OUTROS',114215.13),
(2012,'BANCO ARBI S/A','INVESTIMENTOS',8407843.72),
(2012,'BANCO ARBI S/A','OUTROS',81746.25)

SELECT * FROM ##CONTAS
 
DECLARE @COLUNAS AS VARCHAR(4000) = 
(SELECT STUFF( (SELECT DISTINCT ',' + QUOTENAME(ANO) FROM ##CONTAS FOR XML PATH('')), 1, 1, ''))

SELECT @COLUNAS

DECLARE @QUERY VARCHAR(4000) = 
'
SELECT * 
FROM ##CONTAS AS C
PIVOT (
  SUM(VALOR) FOR
  C.ANO IN (' + @COLUNAS +')
) AS U'

SELECT @QUERY

EXEC(@QUERY)
